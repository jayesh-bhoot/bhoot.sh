<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>How to write a Firefox add-on in ClojureScript</title>

    <style>
        .screenshot {
            width: 50%;
            height: auto;
        }
    </style>
</head>

<body>

<h1>How to write a Firefox add-on in ClojureScript</h1>

<p>
    I found writing Firefox add-ons to be a good way to learn the ropes in ClojureScript
    in a productive manner.
</p>

<p>
    You can find a sample add-on on my
    <a href="https://github.com/jayesh-bhoot/firefox-add-on-in-cljs">GitHub</a>.
    I won’t go through the code here, but will lay out the quirky development process.
    I will mostly focus on the plumbing - how ClojureScript hands over the compiled JavaScript code
    to the add-on.
</p>

<p>
    The sample add-on tries to mirror the functionality of the one found in the
    <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">
        official tutorial </a>
    - wrap a border around the pages at mozilla.org.

    <img class="screenshot"
         src="../static/images/how-to-write-a-firefox-add-on-in-clojurescript.png"
         alt="Screenshot of the add-on in action">
</p>


<h2>Project Layout</h2>

<p>
    Figuring out a clean project layout took some effort. I am satisfied with the following
    structure:
</p>

<pre>
    project-root
    |-- addon  // root for the Firefox add-on
    |   |--- manifest.json
    |   |--- // add-on artefacts like icons
    |   |--- // JS file compiled and placed here by ClojureScript compiler
    |-- src  // ClojureScript code
    |-- compile-opts.edn  // compilation options provided to ClojureScript compiler
    |-- deps.edn
</pre>

<p>
    The goal is to isolate the artefacts of the add-on from the ClojureScript code.
    The add-on gets only its JavaScript from ClojureScript.
    So, isolating the rest of its artefacts - icons, manifest, etc. - into its own directory works
    out well.
    ClojureScript dominates the rest of the project layout.
</p>

<p>
    The only time the ClojureScript compiler touches the <var>addon</var> folder is to put the
    compiled
    JavaScript in it.
</p>

<h2>ClojureScript to JavaScript</h2>

<p>
    The compilation process by default uses <code>:optimizations :none</code>,
    which produces a set of JavaScript files, with the main file pointing at the others.
    This does not work here as the add-on does not seem to pick up the secondary files from the main
    file.
</p>

<p>
    The rest of the <code>:optimizations</code> options -
    <code>:whitespace</code>, <code>:simple</code>, <code>:advanced</code> - produce a single
    standalone JavaScript file, which the add-on happily accepts.
</p>

<p>
    However, <code>:optimizations :none</code> is the default because it compiles the fastest,
    lending a speedy development process.
    I went with the second fastest - <code>:whitespace</code> - for development purpose,
    and <code>:advanced</code> to compile a production build.
</p>

<p>
    Two other compilation options helps keep the plumbing short and clean: <code>:target</code>
    diverts the
    temporary files produced
    during compilation to a <var>tmp</var> folder, while <code>target-to</code> puts the standalone
    compile
    JavaScript file directly into the <var>addon</var> folder.
</p>

<p>
    To summarise, we tweak the default compilation process with the following three options to keep
    life simple:
</p>

<pre>
{:optimizations :whitespace
 :output-dir    "tmp"
 :output-to     "addon/main.js"}
</pre>

<h2>Live reload</h2>

<p>
    Basically, we instruct the ClojureScript compiler to watch over the ClojureScript files and
    recompile them
    into JavaScript on change.
</p>

<pre>
# in project-root
clj --main cljs.main --watch "src" --compile-opts "compile-opts.edn" --compile demo.core
</pre>

<p>
    In turn, Mozilla’s <var>web-ext</var> tool by default watches over the add-on folder and reloads
    the add-on on
    detecting a change.
</p>

<pre>
# in addon folder
web-ext run --start-url https://www.mozilla.org/en-US/
</pre>

<div id="disqus_thread"></div>
<script>

    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function () { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://bhoot-sh.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
    Disqus.</a></noscript>

</body>
</html>